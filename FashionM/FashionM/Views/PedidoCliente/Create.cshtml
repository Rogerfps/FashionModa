@model PedidoCliente

<h2>Nuevo Pedido</h2>

<form asp-action="Create" method="post">

    @Html.AntiForgeryToken()

    <!-- =========================
         BUSCAR CLIENTE
    ========================== -->
    <fieldset>
        <legend>Cliente</legend>

        <label>Cedula</label>
        <input type="number" id="cedula" />
        <button type="button" onclick="buscarCliente()">Buscar</button>

        <input asp-for="ClienteCedula" type="hidden" />

        <div>
            <label>Nombre</label>
            <input id="nombre" readonly />
        </div>

        <div>
            <label>Dirección</label>
            <input id="direccion" readonly />
        </div>

        <div>
            <label>Transporte</label>
            <input id="transporte" readonly />
        </div>

        <div>
            <label>Correo</label>
            <input id="correo" readonly />
        </div>

        <div>
            <label>Teléfono</label>
            <input id="telefono" readonly />
        </div>
        


        
    </fieldset>

    <hr />

    <!-- =========================
         DETALLE DEL PEDIDO
    ========================== -->
    <fieldset>
        <legend>Detalle</legend>
        <table id="tablaDetalle">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Color</th>
                    <th>Talla</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button type="button" onclick="agregarFila()">Agregar Producto</button>
    </fieldset>

    <div>
        <label>Vendedor</label>
        <input asp-for="Vendedor" required />
    </div>

    <div>
        <label>Observaciones</label>
        <textarea asp-for="Observaciones"
                  rows="3"
                  class="form-control"
                  placeholder="Observaciones del pedido"></textarea>
    </div>

    <button type="submit">Guardar Pedido</button>
</form>

@section Scripts {
    <script>
        let index = 0;

        function buscarCliente() {
            const cedula = document.getElementById("cedula").value;

            fetch(`/PedidoCliente/BuscarCliente?cedula=${cedula}`)
                .then(r => {
                    if (!r.ok) throw "Cliente no encontrado";
                    return r.json();
                })
                .then(data => {
                    document.getElementById("nombre").value = data.nombre;
                    document.getElementById("direccion").value = data.direccion;
                    document.getElementById("transporte").value = data.transporte;
                    document.getElementById("correo").value = data.correo;
                    document.getElementById("telefono").value = data.telefonos;


                    document.querySelector("input[name='ClienteCedula']").value = data.cedula;
                })
                .catch(() => alert("Cliente no existe"));
        }

        function agregarFila() {
            document.querySelector("#tablaDetalle tbody").insertAdjacentHTML("beforeend", `
            <tr>
                <td><input name="Detalles[${index}].CodigoProducto" /></td>
                <td><input name="Detalles[${index}].Color" /></td>
                <td><input name="Detalles[${index}].Talla" /></td>
                <td><input type="number" name="Detalles[${index}].Cantidad" value="1" /></td>
                <td><input type="number" step="0.01" name="Detalles[${index}].PrecioUnitario" /></td>
                <td><button type="button" onclick="this.closest('tr').remove()">X</button></td>
            </tr>
            `);
            index++;
        }
    </script>
}